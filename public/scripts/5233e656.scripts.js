"use strict";angular.module("interDromeApp",["ngCookies","ngResource","ngSanitize","ngRoute","google-maps","ngAutocomplete","btford.socket-io","ui.bootstrap","xeditable"]).factory("idSocket",["socketFactory",function(a){console.log("Creating Socket.io connection factory");var b=a();return b.forward("connected"),b.forward("beacon-info"),b.forward("bleep-enter"),b.forward("bleep-exit"),b.forward("hue-bridges"),b.forward("hue-bridge-registration-complete"),b.forward("hue-bridge-get-lights"),b.forward("hue-bridge-lights"),b.forward("wemo-discovery"),b.forward("wemo-found"),b.forward("wemo-set-binary-state-result"),b.forward("xbee"),b}]).config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){a.when("/",{templateUrl:"partials/interzone",controller:"InterZoneCtrl",authenticate:!0}).when("/login",{templateUrl:"partials/login",controller:"LoginCtrl"}).when("/adduser",{templateUrl:"partials/adduser",controller:"AddUserCtrl"}).when("/settings",{templateUrl:"partials/settings",controller:"SettingsCtrl",authenticate:!0}).when("/interzone",{templateUrl:"partials/interzone",controller:"InterZoneCtrl",authenticate:!0}).when("/controls",{templateUrl:"partials/controls",controller:"ControlCtrl",authenticate:!0}).when("/bleeps",{templateUrl:"partials/bleep",controller:"BleepCtrl",authenticate:!0}).when("/events",{templateUrl:"partials/events",controller:"EventCtrl",authenticate:!0}).when("/notifications",{templateUrl:"partials/notifications",controller:"NotificationCtrl",authenticate:!0}).otherwise({redirectTo:"/interzone"}),b.html5Mode(!0),c.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return 401===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}])}]).run(["$rootScope","$location","Auth","editableOptions",function(a,b,c,d){d.theme="bs3",a.$on("$routeChangeStart",function(a,d){d.authenticate&&!c.isLoggedIn()&&b.path("/login")})}]),String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},angular.module("interDromeApp").controller("MainCtrl",["$scope","idSocket",function(a){function b(){var a=new Kinetic.Layer,b=new Image;b.onload=function(){var d=new Kinetic.Image({x:0,y:0,image:b,width:480,height:524});a.add(d),c.add(a)},b.src="images/floorplan.jpg"}a.$on("socket:connected",function(){console.log("Connected")}),a.$on("socket:bleep-enter",function(a,b){console.log("BLEEP Enter "+JSON.stringify(b))}),a.$on("socket:bleep-exit",function(a,b){console.log("BLEEP Exit "+JSON.stringify(b))});var c=new Kinetic.Stage({container:"container",width:480,height:524}),d=0;a.add_bleep=function(){var a=new Kinetic.Layer,b=new Image;b.onload=function(){var e=new Kinetic.Image({x:0,y:0,image:b,width:30,height:26,draggable:!0});a.add(e),c.add(a),d+=1;var f=d;e.on("dragend",function(){console.log("dragend. bleep id "+f+". New x:"+e.x()+", new y:"+e.y())})},b.src="images/tetraeder.gif"},b()}]),angular.module("interDromeApp").controller("NavbarCtrl",["$scope","$location","Auth",function(a,b,c){a.menu=[{title:"Inter.'.Zones",link:"/interzone"},{title:"Bleeps",link:"/bleeps"},{title:"Events",link:"/events"},{title:"Controls",link:"/controls"},{title:"Notifications",link:"/notifications"},{title:"Settings",link:"/settings"}],a.logout=function(){c.logout().then(function(){b.path("/login")})},a.isActive=function(a){return a===b.path()}}]),angular.module("interDromeApp").controller("LoginCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.login=function(d){a.submitted=!0,d.$valid&&b.login({email:a.user.email,password:a.user.password}).then(function(){c.path("/interzone")}).catch(function(b){b=b.data,a.errors.other=b.message})}}]),angular.module("interDromeApp").controller("AddUserCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.register=function(d){a.submitted=!0,d.$valid&&b.createUser({name:a.user.name,email:a.user.email,password:a.user.password}).then(function(){c.path("/")}).catch(function(b){b=b.data,a.errors={},angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.message})})}}]),angular.module("interDromeApp").controller("SettingsCtrl",["$scope","User","Auth",function(a,b,c){a.errors={},a.changePassword=function(b){a.submitted=!0,b.$valid&&c.changePassword(a.user.oldPassword,a.user.newPassword).then(function(){a.message="Password successfully changed."}).catch(function(){b.password.$setValidity("mongoose",!1),a.errors.other="Incorrect password"})}}]),angular.module("interDromeApp").controller("InterZoneCtrl",["$scope","$rootScope","$http","idSocket","InterZone","BootstrapGrowl","Bleep",function(a,b,c,d,e,f,g){function h(){a.interZone={name:"",loc:{latitude:37.7749295,longitude:-122.41941550000001},points:[],angle:-1,pan:-1,zoom:-1,default_zone:!1,dirty:!1,newInstance:!0}}function i(b,c){e.get(function(d){if(d.interZones.unshift({_id:"",name:""}),a.interZoneData=d,"undefined"!=typeof b){for(var e=0;e<a.interZoneData.interZones.length;e++)if(a.interZoneData.interZones[e].name==b){if(a.interZone=a.interZoneData.interZones[e],"undefined"!==a.interZoneControl.reset)try{a.interZoneControl.reset(a.interZone.points)}catch(f){}return void("undefined"!=typeof c&&c())}}else"undefined"!=typeof c&&c()})}function j(){i(void 0,function(){var b=a.selectDefaultZone();b?a.minimized=!0:(h(),a.interZoneEditInfo=!1,a.newInterZone=!1,a.showMap=!1,a.minimized=!1),a.autocomplete=void 0})}function k(){f.success("InterZone Saved",s),i(a.interZone.name),a.interZone.dirty=!1,a.interZoneEditInfo=!0,a.interZoneView=!0,a.newInterZone=!1}function l(){console.log("InterZone not found. Creating new Zone."),a.interZone.angle=0,a.interZone.pan=[0,0],a.interZone.zoom=1,e.save(a.interZone,function(){console.log("saveInterZone save callback"),k()},function(a){f.error("Error saving InterZone; "+JSON.stringify(a),s)})}function m(b,c){for(var d,f=0;f<a.interZoneData.interZones.length;f++)(b&&a.interZoneData.interZones[f]._id===a.interZone._id||!b&&a.interZoneData.interZones[f]._id!==a.interZone._id)&&a.interZoneData.interZones[f].default_zone&&(d=a.interZoneData.interZones[f]);"undefined"!=typeof d?(d.default_zone=!1,e.update({id:d._id},d,function(){"undefined"!=typeof c&&c()})):c()}function n(a,b){a.default_zone=!0,e.update({id:a._id},a,function(){console.log("favorited "+a.name),a.default_zone=!0,"undefined"!=typeof b&&b()})}function o(b,c){if(console.log("\nBeacon Info"),console.log("BLEEP interzone id "+b.interZone),"undefined"!==b.interZone&&a.interZone._id===b.interZone)for(var d=0;d<a.interZone.bleeps.length;d++)a.interZone.bleeps[d]._id===b._id&&(a.interZone.bleeps[d].bleep=b,a.interZoneControl.beaconInfo(b,c))}function p(b,c){if(console.log("\nBLEEP Enter"),console.log("BLEEP interzone id "+b.interZone),"undefined"!==b.interZone&&a.interZone._id===b.interZone)for(var d=0;d<a.interZone.bleeps.length;d++)a.interZone.bleeps[d]._id===b._id&&(a.interZone.bleeps[d].bleep=b,a.interZoneControl.bleepUpdate(b,c,!0))}function q(b,c){if(console.log("\nBLEEP Exit"),console.log("BLEEP interzone id "+b.interZone),"undefined"!==b.interZone&&a.interZone._id===b.interZone)for(var d=0;d<a.interZone.bleeps.length;d++)a.interZone.bleeps[d]._id===b._id&&(a.interZone.bleeps[d].bleep=b,a.interZoneControl.bleepUpdate(b,c,!1))}a.debug=!1,a.width=1024,a.height=468,a.interZoneEdit=!1,a.interZoneWidth=1024,a.interZoneHeight=468,a.interZoneEditInfo=!1,a.newInterZone=!1,a.showMap=!1,a.interZoneControl={},a.interZoneEditorControl={},a.mapControl={},a.interZonePoints,a.minimized=!0,a.bleepData=g.get(),a.lastView={map:!1,selectedView:!1},a.angle,a.pan,a.zoom;var r={panControl:!0,zoomControl:!0,scaleControl:!0,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.SATELLITE,tilt:0};a.map={zoom:24,options:r};var s={ele:"#bootstrap-growl"};a.$on("socket:beacon-info",function(a,b){b.err||o(b.bleep,b.beacon)}),a.$on("socket:bleep-enter",function(a,b){b.err||p(b.bleep,b.beaconAddr)}),a.$on("socket:bleep-exit",function(a,b){b.err||q(b.bleep,b.beaconAddr)}),a.$watch("details.geometry",function(){"undefined"!=typeof a.details&&(a.interZone.loc.latitude=a.details.geometry.location.k,a.interZone.loc.longitude=a.details.geometry.location.A,a.showMap=!0,a.interZoneEditInfo=!0,console.log("autocomplete"+a.autocomplete))},!0),a.$watch("interZone.angle",function(b,c){"undefined"!=typeof a.interZone&&-1!==c&&(a.interZone.dirty=!0)}),a.$watch("interZone.points",function(b,c){"undefined"!=typeof c&&0!==c.length&&(a.interZone.dirty=!0)}),a.$watch("interZone.pan",function(b,c){"undefined"!=typeof c&&-1!==c&&(a.interZone.dirty=!0)}),a.$watch("interZone.zoom",function(b,c){"undefined"!=typeof c&&-1!==c&&(a.interZone.dirty=!0)}),a.createInterZone=function(){a.lastView.map=!0,a.lastView.selectedView=!1,h(),a.newInterZone=!0,a.interZoneEditInfo=!1,a.interZoneView=!1,a.showMap=!1,a.autocomplete=void 0,a.details=void 0,a.interZonePoints=a.interZone.points},a.interZoneSelected=function(){if(a.lastView.map=!1,a.lastView.selectedView=!0,a.newInterZone=!1,a.interZoneEditInfo=!0,a.interZoneEdit=!1,a.showMap=!1,a.interZoneView=!0,a.autocomplete=void 0,a.details=void 0,a.interZonePoints=a.interZone.points,"undefined"!==a.interZoneControl.reset)try{a.interZoneControl.reset(a.interZone.points)}catch(b){}if("undefined"!==a.interZoneEditorControl.reset)try{a.interZoneEditorControl.reset(a.interZone.points)}catch(b){}a.interZone.dirty=!1},a.editInterZone=function(){a.showMap=!0,a.interZoneEdit=!0,a.interZoneView=!1;setTimeout(function(){a.mapControl.refresh(a.interZone.loc),a.map.zoom=24},100)},a.cancelEdit=function(){a.interZoneEdit=!1,a.lastView.map||a.lastView.selectedView&&(a.interZoneEditInfo=!0,a.interZoneView=!0,a.showMap=!1)},a.saveInterZone=function(){if(0===a.interZone.name.length)f.error("Error: InterZone Name Required.",s);else if(0===a.interZone.points.length)f.error("Error: InterZone Floor Plan Required.",s);else if(a.showMap=!1,a.interZoneEdit=!1,"undefined"!=typeof a.interZone._id){e.get({id:a.interZone._id},function(b){console.log("InterZone found with id "+b._id),b.name=a.interZone.name,b.angle=a.interZone.angle,b.pan=a.interZone.pan,b.zoom=a.interZone.zoom,b.default_zone=a.interZone.default_zone,b.points=a.interZone.points,b.bleeps=a.interZone.bleeps,console.log("Updating InterZone to: "+JSON.stringify(b)),b.$update({id:b._id},function(){k()})},function(){l()})}else l()},a.interZoneControl.bleepChange=function(a){console.log("bleep changed. bleep location: "+JSON.stringify(a.location)),g.update({id:a._id},a,function(){console.log("bleep update callback")})},a.clearInterZone=function(){a.interZoneEditorControl.clear()},a.hideMap=function(){a.showMap=!1},a.checkName=function(a){console.log("Checking name "+a)},a.changeFavorite=function(){a.interZone.default_zone?m(!0):m(!1,function(){n(a.interZone)})},a.selectDefaultZone=function(){for(var b=0;b<a.interZoneData.interZones.length;b++)if(a.interZoneData.interZones[b].default_zone)return"undefined"!=typeof a.interZone&&a.interZoneData.interZones[b]._id===a.interZone._id?void 0:(a.interZone=a.interZoneData.interZones[b],a.interZoneSelected(),!0);return!1},a.minMax=function(){a.minimized?(a.minimized=!1,$(".collapse").collapse("show")):(a.minimized=!0,$(".collapse").collapse("hide"))},a.collapseClass=function(b){return a.minimized?b+" collapse":b+" collapse in"},a.minimizeToolTip=function(){return a.minimized?"Click to Maximize":"Click to Minimize"},a.favoriteToolTip=function(){return a.interZone.default_zone?"Click to Reset Favorite":"Click to Favorite"},a.addBleep=function(b){for(var c=0;c<a.interZone.bleeps.length;c++)if(a.interZone.bleeps[c]._id===b._id)return void console.log("BLEEP already in zone.");b.interZone=a.interZone._id,a.interZoneControl.addBleep(b)},a.interZoneControl.ready=function(){a.interZone.newInstance||a.interZoneControl.reset(a.interZone.points)},a.interZoneEditorControl.ready=function(){a.interZone.newInstance||a.interZoneEditorControl.reset(a.interZone.points)},j()}]),angular.module("interDromeApp").controller("ControlCtrl",["$scope","idSocket","HueBridge","Wemo","$modal","$log",function(a,b,c,d,e,f){function g(b,d){d.err||(a.hueBridges=c.get(),h.dismiss("cancel"))}var h;a.discoverHueBridgeDisabled=!1,a.discoverWemoDevicesDisabled=!1,a.hueBridges=c.get(),a.wemo,a.$on("socket:hue-bridges",function(b,c){console.log("Hue Bridges Discovered "+JSON.stringify(c)),a.discoverHueBridgeDisabled=!1,a.hueBridges=c}),a.$on("socket:wemo-found",function(b,c){if(console.log("Wemo Device Discovered "+JSON.stringify(c)),"undefined"!=typeof a.wemo&&"undefined"!=typeof a.wemo.devices){for(var d=0;d<a.wemo.devices.length;d++)if(a.wemo.devices[d].ip===c.ip)return console.log("Wemo Already Found"),void(a.discoverWemoDevicesDisabled=!1);a.wemo.devices.push(c),a.$digest()}else a.wemo={devices:[]},a.wemo.devices.push(c),a.$digest();a.discoverWemoDevicesDisabled=!1}),a.discoverHueBridges=function(){console.log("Discovering Hue Bridges"),a.discoverHueBridgeDisabled=!0,b.emit("hue",{action:"discovery"},function(){console.log("emit callback")})},a.openHueBidgeModal=function(a){h=e.open("undefined"==typeof a.user?{templateUrl:"hue-bridge-modal-register-content",controller:HueBridgeRegisterModalInstanceCtrl,resolve:{socket:function(){return b},bridge:function(){return a},registrationComplete:function(){return g}}}:{templateUrl:"hue-bridge-modal-lights-content",controller:HueBridgeLightsModalInstanceCtrl,resolve:{socket:function(){return b},selectedBridge:function(){return a},HueBridge:function(){return c}}}),h.result.then(function(){},function(){f.info("Modal dismissed at: "+new Date)})},a.openWemoDeviceModal=function(a){h=e.open({templateUrl:"wemo-device-content",controller:WemoDeviceModalInstanceCtrl,resolve:{socket:function(){return b},wemoDevice:function(){return a}}}),h.result.then(function(){},function(){f.info("Modal dismissed at: "+new Date)})},a.discoverWemoDevices=function(){console.log("Discovering Wemo Devices"),a.discoverWemoDevicesDisabled=!0,b.emit("wemo",{action:"discovery"},function(){console.log("emit callback")}),setTimeout(function(){a.discoverWemoDevicesDisabled&&(console.log("Re-enabling Wemo Device Search"),a.discoverWemoDevicesDisabled=!1,a.$digest())},1e4)}}]);var HueBridgeRegisterModalInstanceCtrl=function(a,b,c,d,e){a.bridge=d,a.registerHueBridgeDisabled=!1,a.alerts=[],a.closeAlert=function(b){a.alerts.splice(b,1)},a.$on("socket:hue-bridge-registration-complete",function(b,c){console.log("Hue Bridge Registration Complete "+JSON.stringify(c)),c.err&&a.alerts.push({type:"danger",msg:"Error: "+c.err.message.capitalize()}),a.registerHueBridgeDisabled=!1,e(b,c)}),a.register=function(){a.alerts=[],a.registerHueBridgeDisabled=!0,c.emit("hue",{action:"register",bridge:d},function(){console.log("emit callback")})},a.cancel=function(){b.dismiss("cancel")}},HueBridgeLightsModalInstanceCtrl=function(a,b,c,d,e){a.bridge=d,a.alerts=[],a.hueBridgeName,c.emit("hue",{action:"getLights",bridge:d},function(){console.log("emit callback")}),a.$on("socket:hue-bridge-get-lights",function(b,c){c.err?a.alerts.push({type:"danger",msg:"Error: "+c.err.message.capitalize()}):a.lights=c.lights}),a.$on("socket:hue-bridge-lights",function(b,c){c.err?a.alerts.push({type:"danger",msg:"Error: "+c.err.message.capitalize()}):console.log("Hue Bridge Lights Response "+JSON.stringify(c))}),a.setHueBridgeName=function(b){13==b&&e.update({id:a.bridge._id,name:a.bridge.name})},a.closeAlert=function(b){a.alerts.splice(b,1)},a.turnOn=function(b){a.alerts=[],c.emit("hue",{action:"on",bridge:bridge,light:b},function(){console.log("emit callback")})},a.turnOff=function(b){a.alerts=[],c.emit("hue",{action:"off",bridge:bridge,light:b},function(){console.log("emit callback")})},a.cancel=function(){b.dismiss("cancel")}},WemoDeviceModalInstanceCtrl=function(a,b,c,d){a.alerts=[],a.wemoDevice=d,a.$on("socket:wemo-set-binary-state-result",function(b,c){console.log(JSON.stringify(c)),c.err&&a.alerts.push({type:"danger",msg:"Error: "+c.err.code.capitalize()})}),a.closeAlert=function(b){a.alerts.splice(b,1)},a.turnOn=function(){a.alerts=[],c.emit("wemo",{action:"on",wemoDevice:d},function(){console.log("emit callback")})},a.turnOff=function(){a.alerts=[],c.emit("wemo",{action:"off",wemoDevice:d},function(){console.log("emit callback")})},a.cancel=function(){b.dismiss("cancel")}};angular.module("interDromeApp").controller("BleepCtrl",["$scope","Bleep","$modal","$log","idSocket","Beacon",function(a,b,c,d,e,f){function g(c){if("undefined"!=typeof a.bleepData.bleeps){for(var d=a.bleepData.bleeps,e=0;e<d.length;e++)if(console.log("Does "+d[e].address+" equal "+c.bleep.address),d[e].address===c.bleep.address)return a.bleepData.bleeps[e].beacons=c.bleep.beacons,void a.$digest()}else a.bleepData=b.get()}function h(b){a.selectedBeacon.name=b.name}a.bleepData=b.get(),a.selectedBleepRef,a.selectedBleep,a.selectedBeacon,a.bleepChanged=!1;var i;a.$on("socket:bleep-enter",function(a,b){b.err||(console.log("BLEEP Enter"),g(b))}),a.$on("socket:bleep-exit",function(a,b){b.err||(console.log("BLEEP Exit"),g(b))}),a.editBleep=function(b){a.selectedBleep=b,a.selectedBleepRef=JSON.parse(JSON.stringify(b))},a.itemClass=function(b){return b===a.selectedBleep?"list-group-item active":"list-group-item"},a.beaconItemClass=function(b){return b===a.selectedBeacon?"list-group-item active":"list-group-item"},a.setBleepChanged=function(){a.bleepChanged=a.selectedBleep.name!==a.selectedBleepRef.name?!0:!1},a.saveBleep=function(){b.update({id:a.selectedBleep._id,name:a.selectedBleep.name}),a.selectedBleepRef=JSON.parse(JSON.stringify(a.selectedBleep)),a.bleepChanged=!1},a.showBeacon=function(b){a.selectedBeacon=b,"undefined"==typeof i&&(i=c.open({templateUrl:"bleep-beacon-modal-content",controller:BleepBeaconModalInstanceCtrl,resolve:{selectedBeacon:function(){return a.selectedBeacon},socket:function(){return e},beacon:function(){return f},beaconChange:function(){return h}}}),i.result.then(function(){},function(){i=void 0,d.info("Modal dismissed at: "+new Date)}))}}]);var BleepBeaconModalInstanceCtrl=function(a,b,c,d,e){a.selectedBeacon=JSON.parse(JSON.stringify(c)),a.selectedBeaconRef=JSON.parse(JSON.stringify(c)),a.beaconChanged=!1,a.setBeaconChanged=function(){a.beaconChanged=a.selectedBeacon.name!==a.selectedBeaconRef.name?!0:!1},a.close=function(){b.dismiss("cancel")},a.save=function(){d.update({id:c._id,name:a.selectedBeacon.name}),a.selectedBeaconRef=JSON.parse(JSON.stringify(c)),a.beaconChanged=!1,e(a.selectedBeacon)}};angular.module("interDromeApp").controller("EventCtrl",["$scope",function(a){a.interZoneWidth=1024,a.interZoneHeight=468,a.angle=316,a.pan=[-312.0016234354316,-115.4506741956165],a.zoom=1.584514132467325,a.interZonePoints=[[470.83856201171875,77.34637451171875],[529.8385620117188,126.34637451171875],[545.8385620117188,116.34637451171875],[633.8385620117188,206.34637451171875],[610.8385620117188,232.34637451171875],[621.8385620117188,247.34637451171875],[592.8385620117188,295.34637451171875],[599.8385620117188,305.34637451171875],[547.8385620117188,357.34637451171875],[502.83856201171875,305.34637451171875],[524.8385620117188,279.34637451171875],[457.83856201171875,210.34637451171875],[465.83856201171875,197.34637451171875],[419.83856201171875,155.34637451171875],[455.83856201171875,110.34637451171875],[448.83856201171875,97.34637451171875],[470.83856201171875,75.34637451171875]]}]),angular.module("interDromeApp").controller("NotificationCtrl",["$scope","Notification",function(a,b){function c(){a.alerts=[],a.alerts.push({type:"warning",msg:"Note: Requires additional setup. Check the Settings Tab above."})}a.notifications=b.get(),a.createNotification=!1,a.newNotification,a.alerts=[],a.closeAlert=function(b){a.alerts.splice(b,1)},a.create=function(){a.newNotification={},a.createNotification=!0,c()},a.cancelCreate=function(){a.createNotification=!1},a.saveNewNotification=function(){console.log("saving new Notification")}}]),angular.module("interDromeApp").factory("Auth",["$location","$rootScope","Session","User","$cookieStore",function(a,b,c,d,e){return b.currentUser=e.get("user")||null,e.remove("user"),{login:function(a,d){var e=d||angular.noop;return c.save({email:a.email,password:a.password},function(a){return b.currentUser=a,e()},function(a){return e(a)}).$promise},logout:function(a){var d=a||angular.noop;return c.delete(function(){return b.currentUser=null,d()},function(a){return d(a)}).$promise},createUser:function(a,c){var e=c||angular.noop;return d.save(a,function(a){return b.currentUser=a,e(a)},function(a){return e(a)}).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.update({oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},currentUser:function(){return d.get()},adminUser:function(){var a=d.get();return a},isLoggedIn:function(){var a=b.currentUser;return!!a}}}]),angular.module("interDromeApp").factory("Session",["$resource",function(a){return a("/api/session/")}]),angular.module("interDromeApp").factory("User",["$resource",function(a){return a("/api/users/:id",{id:"@id"},{update:{method:"PUT",params:{}},get:{method:"GET",params:{id:"me"}}})}]),angular.module("interDromeApp").factory("HueBridge",["$resource",function(a){return a("/api/hue/bridges",{},{update:{method:"PUT",params:{id:"@id",name:"@name"}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").factory("Bleep",["$resource",function(a){return a("/api/bleeps/:id",{id:"@id"},{update:{method:"PUT",params:{id:"@id",name:"@name",location:"@location",interZone:"@interZone"}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").factory("Wemo",["$resource",function(a){return a("/api/wemos",{},{update:{method:"PUT",params:{}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").factory("Beacon",["$resource",function(a){return a("/api/beacons",{},{update:{method:"PUT",params:{id:"@id",name:"@name"}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").factory("Notification",["$resource",function(a){return a("/api/notifications",{},{update:{method:"PUT",params:{id:"@id",name:"@name",pushover_user:"@pushover_user",email:"@email"}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").factory("InterZone",["$resource",function(a){return a("/api/interzones/:id",{id:"@id"},{update:{method:"PUT",params:{name:"@name",loc:"@loc",points:"@points",angle:"@angle",pan:"@pan",zoom:"@zoom",default_zone:"@default_zone",bleeps:"@bleeps"}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").factory("BootstrapGrowl",["$rootScope",function(){function a(a,b,c){"undefined"==typeof c&&(c={}),c.type=b,$(document).ready(function(){$.bootstrapGrowl(a,c)})}return{info:function(b,c){a(b,"info",c)},error:function(b,c){a(b,"danger",c)},success:function(b,c){a(b,"success",c)}}}]),angular.module("interDromeApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("interDromeApp").directive("a",function(){return{restrict:"E",link:function(a,b,c){if(c.ngClick||""===c.href||"#"===c.href){var d=$(b[0]).attr("class");("undefined"==typeof d||"undefined"!=typeof d&&d.indexOf("accordion-toggle")<0)&&b.on("click",function(b){b.preventDefault(),c.ngClick&&a.$eval(c.ngClick)})}}}}),angular.module("interDromeApp").directive("donutChart",function(){function a(a,b){var c=d3.scale.category10(),d=[10,20,30],e=300,f=300,g=Math.min(e,f),h=d3.select(b[0]).append("svg"),i=d3.layout.pie().sort(null),j=d3.svg.arc().outerRadius(g/2*.9).innerRadius(g/2*.5);h.attr({width:e,height:f});var k=h.append("g").attr("transform","translate("+e/2+","+f/2+")");k.selectAll("path").data(i(d)).enter().append("path").style("stroke","white").attr("d",j).attr("fill",function(a,b){return c(b)})}return{link:a,restrict:"E"}}),angular.module("interDromeApp").directive("interzoneEditor",["$rootScope",function(a){function b(){j.select("path").attr("d",m);var c=j.selectAll("circle").data(n,function(a){return a});c.enter().append("circle").attr("r",1e-6).on("mousedown",function(a){l=k=a,b()}).transition().duration(750).ease("elastic").attr("r",6.5),c.classed("selected",function(a){return a===l}).attr("cx",function(a){return a[0]}).attr("cy",function(a){return a[1]}),c.exit().remove(),d3.event&&(d3.event.preventDefault(),d3.event.stopPropagation()),a.$$phase||o.$$phase||o.$apply()}function c(){m.interpolate(this.value),b()}function d(){n.push(l=k=d3.mouse(j.node())),b()}function e(){if(k){var a=d3.mouse(j.node());k[0]=Math.max(0,Math.min(p,a[0])),k[1]=Math.max(0,Math.min(q,a[1])),b()}}function f(){k&&(e(),k=null)}function g(){if(l)switch(d3.event.keyCode){case 8:case 46:var a=n.indexOf(l);n.splice(a,1),l=n.length?n[a>0?a-1:0]:null,b()}}function h(a,h){p=a.width,q=a.height,k=null,l=n[0],m=d3.svg.line(),j=d3.select(h[0]).append("svg").attr("width",p).attr("height",q).attr("tabindex",1),j.append("rect").attr("width",p).attr("height",q).on("mousedown",d),j.append("path").datum(n).attr("class","line").call(b),d3.select(window).on("mousemove",e).on("mouseup",f).on("keydown",g),d3.select("#interpolate").on("change",c).selectAll("option").data(["linear","step-before","step-after","basis","basis-open","basis-closed","cardinal","cardinal-open","cardinal-closed","monotone"]).enter().append("option").attr("value",function(a){return a}).text(function(a){return a}),j.node().focus()}function i(a,c,d){o=a,n=a.points,a.internalControl=a.control||{},a.internalControl.reset=function(e){d3.select(c[0]).selectAll("svg").remove(),n=e,h(a,c,d),b()},a.internalControl.clear=function(){for(var a=0;a<n.length;a++)n.splice(a,1),l=n.length?n[a>0?a-1:0]:null;n.length>=0&&b()},h(a,c,d),a.internalControl.ready()}var j,k,l,m,n,o,p=960,q=500;return{link:i,restrict:"E",scope:{width:"=",height:"=",points:"=",control:"="}}}]),angular.module("interDromeApp").directive("interzone",["$rootScope",function(a){function b(){f.select("path").attr("d",g),d3.event&&(d3.event.preventDefault(),d3.event.stopPropagation()),a.$$phase||i.$$phase||i.$apply()}function c(){}function d(a,d){console.log("Creating D3 Interzone SVG Map"),c(),g=d3.svg.line(),f=d3.select(d[0]).append("svg").attr("width",j).attr("height",k).attr("tabindex",1),f.append("rect").attr("width",j).attr("height",k),f.append("path").datum(h).attr("class","line").call(b),d3.select("#interpolate").selectAll("option").data(["linear","step-before","step-after","basis","basis-open","basis-closed","cardinal","cardinal-open","cardinal-closed","monotone"]).enter().append("option").attr("value",function(a){return a}).text(function(a){return a}),f.node().focus()}function e(a,c,e){i=a,j=a.width,k=a.height,h=a.points,a.internalControl=a.control||{},a.internalControl.reset=function(f){console.log("reset called"),d3.select(c[0]).selectAll("svg").remove(),h=f,d(a,c,e),b()},d(a,c,e)}var f,g,h,i,j=960,k=500;return{link:e,restrict:"E",scope:{width:"=",height:"=",points:"=",control:"="}}}]),angular.module("interDromeApp").directive("interzoneDragZoom",["$rootScope","$location",function(a,b){function c(a){var b=G[a].filter,c=1,d=!0,e=0;b.attr("stdDeviation",.2),"undefined"!=typeof G[a].interval&&clearInterval(G[a].interval),G[a].interval=setInterval(function(){d?b.attr("stdDeviation",(c+=5)/5):b.attr("stdDeviation",(c-=5)/5),c>=50?(d=!1,e+=1):5>=c&&(d=!0),e>=3&&d&&(clearInterval(G[a].interval),b.attr("stdDeviation",0))},90)}function d(){x.select("path").attr("d",A),d3.event&&(d3.event.preventDefault(),d3.event.stopPropagation()),a.$$phase||C.$$phase||C.$apply()}function e(){d3.event.sourceEvent.srcElement.classList;C.pan=d3.event.translate,C.zoom=d3.event.scale,a.$$phase||C.$$phase||C.$apply(),f(C.pan,C.zoom)}function f(a,b){y.attr("transform","translate("+a+")scale("+b+")")}function g(a){var b=a.node(),c=b.getBBox();return[c.x+c.width/2,c.y+c.height/2]}function h(a){E=D.select("#interzone-floor-plan").transform("r"+a)}function i(d){var e=g(z);if(console.log("InterZone Center "+JSON.stringify(e)),"undefined"==typeof d.location&&(d.location={}),d.location.x=d.location.x||e[0],d.location.y=d.location.y||e[1],!(d._id in G)){var f=x.select("defs").append("filter").attr("id","blur-"+d._id).attr("filterUnits","userSpaceOnUse").append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation",1);G[d._id]={},G[d._id].filter=f}if(!(d._id in F)){var h=z.append("g").attr("id",d._id).data([{x:d.location.x,y:d.location.y}]);h.append("circle").attr("class",d._id).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("r",H).attr("style","fill:darkred;stroke:darkred;stroke-width:.5;fill-opacity:1;").attr("filter","url("+b.path()+"#blur-"+d._id+")");var i=h.append("circle").attr("id","bleep-"+d._id).attr("class","bleep").attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("r",H).attr("cursor","move").attr("style","fill:red;stroke:white;fill-opacity:1;stroke-width:1;").attr("data-container","body").attr("data-toggle","popover").attr("data-placement","right").attr("data-content",d.name).call(d3.behavior.drag().origin(function(a){return a}).on("dragstart",function(){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0),$("#bleep-"+d._id).popover("hide")}).on("drag",function(b){$("#bleep-"+d._id).popover("hide"),d.location.x=Math.max(H,Math.min(u-H,d3.event.x)),d.location.y=Math.max(H,Math.min(v-H,d3.event.y)),a.$$phase||C.$$phase||C.$apply(),d3.select($("#"+d._id)[0]).selectAll("circle").attr("cx",b.x=d.location.x).attr("cy",b.y=d.location.y)}).on("dragend",function(){d3.select(this).classed("dragging",!1),c(d._id);var a=j(d._id);C.internalControl.bleepChange(a),k(a)})).on("mouseover",function(){d3.event.preventDefault(),$("#bleep-"+d._id).popover("show")}).on("mouseout",function(){d3.event.preventDefault(),$("#bleep-"+d._id).popover("hide")});F[d._id]={sphere:i,rsmall:{},rmedium:{},rlarge:{}},c(d._id)}}function j(a){for(var b=0;b<C.bleeps.length;b++)if(C.bleeps[b]._id===a)return C.bleeps[b]}function k(a,b,c){g(F[a._id].sphere);"undefined"==typeof b&&(b=0),console.log("Add Beacons "+JSON.stringify(a)),p(a);for(var d=(z.append("g").attr("id","beacons-"+a._id).attr("class","beacons"),0);d<a.beacons.length;d++){var e=a.beacons[d]._id,f=l(a,a.beacons[d]),h=x.select("#beacon-circle-group-"+e).append("g").attr("transform","translate("+[f.x,f.y]+")");if(h.append("rect").attr("id","beacon-"+e).attr("class",".beacon").attr("x",0).attr("y",0).attr("width",5).attr("height",5).attr("style","fill:orange;stroke:white;stroke-width:1;").attr("data-container","body").attr("data-toggle","popover").attr("data-placement","bottom").attr("data-content",a.beacons[d].name).on("mouseover",function(){d3.event.preventDefault(),$(this).popover("show")}).on("mouseout",function(){d3.event.preventDefault(),$(this).popover("hide")}),"undefined"==typeof c||c!==!0){setTimeout(function(){$("#beacon-"+e).popover("show")},b);{setTimeout(function(){$("#beacon-"+e).popover("hide")},3500)}}}}function l(a,b){var c=g(F[a._id].sphere);console.log(c);var d=Math.PI,e=m(a,b),f=d3.svg.arc().innerRadius(e.r-2).outerRadius(e.r).startAngle(d/180).endAngle(7),h=z.select("#beacons-"+a._id).append("g").attr("id","beacon-circle-group-"+b._id).attr("transform","translate("+[c[0],c[1]]+")");h.append("path").attr("id","beacon-circle-"+b._id).attr("d",f).attr("style","fill:#111");var i=z.select("#beacon-circle-"+b._id).node(),j=i.getPointAtLength(o(a,b,e.rsize));return j}function m(a,b){var c=Math.abs(b.rssi);return console.log("RSSI "+c),70>c?(n(a,b,I),{r:15,rsize:I}):c>70&&80>c?(n(a,b,J),{r:25,rsize:J}):(n(a,b,K),{r:30,rsize:K})}function n(a,b,c){b._id in F[a._id][c]||(delete F[a._id][I][b._id],delete F[a._id][J][b._id],delete F[a._id][K][b._id],F[a._id][c][b._id]=void 0)}function o(a,b,c){var d=Object.keys(F[a._id][c]).length;return"undefined"==typeof F[a._id][c][b._id]&&(F[a._id][c][b._id]=1===d?0:d+5),console.log("BEACONS IN RSIZE "+Object.keys(F[a._id][c]).length),console.log("BEACON POS "+F[a._id][c][b._id]),F[a._id][c][b._id]}function p(a){q(a),z.selectAll("#beacons-"+a._id).remove()}function q(a){for(var b=0;b<a.beacons.length;b++)$("#beacon-"+a.beacons[b]._id).popover("hide")
}function r(a,b){t={top:-5,right:-5,bottom:-5,left:-5},u=a.width-t.left-t.right,v=a.height-t.top-t.bottom,w=d3.behavior.zoom().scaleExtent([1,10]).on("zoom",e),x=d3.select(b[0]).append("svg").attr("id","interdrome-container").attr("width",u+t.left+t.right).attr("height",v+t.top+t.bottom).append("g").attr("transform","translate("+t.left+","+t.right+")").call(w).on("mousedown",function(){d3.event.preventDefault(),d3.select(this).classed("zooming",!0)}).on("mouseup",function(){d3.event.preventDefault(),d3.select(this).classed("zooming",!1)}),x.append("defs"),x.append("rect").attr("width",u).attr("height",v).style("fill","none").style("pointer-events","all"),y=x.append("g"),y.append("g").attr("class","x axis").selectAll("line").data(d3.range(0,u,10)).enter().append("line").attr("x1",function(a){return a}).attr("y1",0).attr("x2",function(a){return a}).attr("y2",v),y.append("g").attr("class","y axis").selectAll("line").data(d3.range(0,v,10)).enter().append("line").attr("x1",0).attr("y1",function(a){return a}).attr("x2",u).attr("y2",function(a){return a}),z=y.append("g").attr("id","interzone-floor-plan"),z.append("path").datum(B).attr("class","interzone-line").call(d),D=Snap("#interdrome-container"),h(a.angle),d3.select("#interpolate").selectAll("option").data(["linear","step-before","step-after","basis","basis-open","basis-closed","cardinal","cardinal-open","cardinal-closed","monotone"]).enter().append("option").attr("value",function(a){return a}).text(function(a){return a}),f(C.pan,C.zoom),a.$watch("angle",function(){"number"==typeof a.angle&&h(a.angle)},!0),a.$watch("zoom",function(){f(C.pan,C.zoom)},!0)}function s(a,b,e){C=a,B=a.points,A=d3.svg.line(),a.internalControl=a.control||{},a.internalControl.clear=function(){},a.internalControl.addBleep=function(a){C.bleeps.push(a),i(a)},a.internalControl.reset=function(c){if(d3.select(b[0]).selectAll("svg").remove(),B=c,r(a,b,e),d(),"undefined"!=typeof C.bleeps)for(var f=0;f<C.bleeps.length;f++)i(C.bleeps[f]),k(C.bleeps[f],500)},a.internalControl.bleepUpdate=function(a,b,d){c(a._id),d?k(a):k(a,0,!0)},a.internalControl.beaconInfo=function(a){k(a,0,!0)},r(a,b,e),a.internalControl.ready()}var t,u,v,w,x,y,z,A,B,C,D,E,F={},G={},H=5,I="rsmall",J="rmedium",K="rlarge";return{link:s,restrict:"E",scope:{width:"=",height:"=",points:"=",control:"=",angle:"=",pan:"=",zoom:"=",bleeps:"="}}}]),angular.module("interDromeApp").directive("bootstrapSlider",["$rootScope","$parse",function(a,b){var c=!1;return{restrict:"E",replace:!0,template:'<input type="text" />',link:function(d,e,f){var g=b(f.model);if(void 0!==typeof f.handle)var h=$(e[0]).slider({handle:f.handle,value:f.bootstrapSliderValue});else var h=$(e[0]).slider();h.on("slide",function(a){"number"==typeof a.value&&(g.assign(d,a.value),d.$apply())}),h.on("slideStart",function(){c=!0}),h.on("slideStop",function(){c=!1}),d.$watch(f.model,function(b){var d=setTimeout(function(){a.$$phase||"number"!=typeof b||c||(h.slider("setValue",b),clearInterval(d))},100)},!0)}}}]);