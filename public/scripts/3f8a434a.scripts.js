"use strict";angular.module("interDromeApp",["ngCookies","ngResource","ngSanitize","ngRoute","google-maps","ngAutocomplete","btford.socket-io","ui.bootstrap"]).factory("idSocket",["socketFactory",function(a){console.log("Creating Socket.io connection factory");var b=a();return b.forward("connected"),b.forward("bleep-enter"),b.forward("bleep-exit"),b.forward("hue-bridges"),b.forward("hue-bridge-registration-complete"),b.forward("hue-bridge-get-lights"),b.forward("hue-bridge-lights"),b.forward("wemo-discovery"),b.forward("xbee"),b}]).config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){a.when("/",{templateUrl:"partials/main",controller:"MainCtrl",authenticate:!0}).when("/login",{templateUrl:"partials/login",controller:"LoginCtrl"}).when("/adduser",{templateUrl:"partials/adduser",controller:"AddUserCtrl"}).when("/settings",{templateUrl:"partials/settings",controller:"SettingsCtrl",authenticate:!0}).when("/interzone",{templateUrl:"partials/interzone",controller:"InterZoneCtrl",authenticate:!0}).when("/controls",{templateUrl:"partials/controls",controller:"ControlCtrl",authenticate:!0}).when("/bleeps",{templateUrl:"partials/bleep",controller:"BleepCtrl",authenticate:!0}).when("/events",{templateUrl:"partials/events",controller:"EventCtrl",authenticate:!0}).when("/notifications",{templateUrl:"partials/notifications",controller:"NotificationCtrl",authenticate:!0}).otherwise({redirectTo:"/"}),b.html5Mode(!0),c.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return 401===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}])}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$on("$routeChangeStart",function(a,d){d.authenticate&&!c.isLoggedIn()&&b.path("/login")})}]),String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},angular.module("interDromeApp").controller("MainCtrl",["$scope","idSocket",function(a){function b(){var a=new Kinetic.Layer,b=new Image;b.onload=function(){var d=new Kinetic.Image({x:0,y:0,image:b,width:480,height:524});a.add(d),c.add(a)},b.src="images/floorplan.jpg"}a.$on("socket:connected",function(){console.log("Connected")}),a.$on("socket:bleep-enter",function(a,b){console.log("BLEEP Enter "+JSON.stringify(b))}),a.$on("socket:bleep-exit",function(a,b){console.log("BLEEP Exit "+JSON.stringify(b))});var c=new Kinetic.Stage({container:"container",width:480,height:524}),d=0;a.add_bleep=function(){var a=new Kinetic.Layer,b=new Image;b.onload=function(){var e=new Kinetic.Image({x:0,y:0,image:b,width:30,height:26,draggable:!0});a.add(e),c.add(a),d+=1;var f=d;e.on("dragend",function(){console.log("dragend. bleep id "+f+". New x:"+e.x()+", new y:"+e.y())})},b.src="images/tetraeder.gif"},b()}]),angular.module("interDromeApp").controller("NavbarCtrl",["$scope","$location","Auth",function(a,b,c){a.menu=[{title:"Home",link:"/"},{title:"Inter.'.Zones",link:"/interzone"},{title:"Controls",link:"/controls"},{title:"Bleeps",link:"/bleeps"},{title:"Events",link:"/events"},{title:"Notifications",link:"/notifications"},{title:"Settings",link:"/settings"}],a.logout=function(){c.logout().then(function(){b.path("/login")})},a.isActive=function(a){return a===b.path()}}]),angular.module("interDromeApp").controller("LoginCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.login=function(d){a.submitted=!0,d.$valid&&b.login({email:a.user.email,password:a.user.password}).then(function(){c.path("/")}).catch(function(b){b=b.data,a.errors.other=b.message})}}]),angular.module("interDromeApp").controller("AddUserCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.register=function(d){a.submitted=!0,d.$valid&&b.createUser({name:a.user.name,email:a.user.email,password:a.user.password}).then(function(){c.path("/")}).catch(function(b){b=b.data,a.errors={},angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.message})})}}]),angular.module("interDromeApp").controller("SettingsCtrl",["$scope","User","Auth",function(a,b,c){a.errors={},a.changePassword=function(b){a.submitted=!0,b.$valid&&c.changePassword(a.user.oldPassword,a.user.newPassword).then(function(){a.message="Password successfully changed."}).catch(function(){b.password.$setValidity("mongoose",!1),a.errors.other="Incorrect password"})}}]),angular.module("interDromeApp").controller("InterZoneCtrl",["$scope","$http","idSocket",function(a){a.width=960,a.height=500,a.showFloorPlan=!1,a.$on("socket:bleep-enter",function(a,b){console.log("BLEEP Enter "+JSON.stringify(b))}),a.$on("socket:bleep-exit",function(a,b){console.log("BLEEP Exit "+JSON.stringify(b))});var b={panControl:!0,zoomControl:!0,scaleControl:!0,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.SATELLITE,tilt:0};a.map={zoom:24,options:b},a.editFloorPlan=function(){a.showFloorPlan=!0},a.saveFloorPlan=function(){a.showFloorPlan=!1};{var c=d3.range(1,5).map(function(b){return[b*a.width/5,50+Math.random()*(a.height-100)]});c[0],d3.svg.line(),d3.select("#floorplan").append("svg").attr("width",a.width-20).attr("height",a.height-20).attr("tabindex",1)}}]),angular.module("interDromeApp").controller("ControlCtrl",["$scope","idSocket","HueBridge","$modal","$log",function(a,b,c,d,e){function f(b,d){d.err||(a.hueBridges=c.get(),g.dismiss("cancel"))}var g;a.discoverHueBridgeDisabled=!1,a.hueBridges=c.get(),a.$on("socket:hue-bridges",function(b,c){console.log("Hue Bridges Discovered "+JSON.stringify(c)),a.discoverHueBridgeDisabled=!1,a.hueBridges=c}),a.discoverHueBridges=function(){console.log("Discovering Hue Bridges"),a.discoverHueBridgeDisabled=!0,b.emit("hue",{action:"discovery"},function(){console.log("emit callback")})},a.openHueBidgeModal=function(a){g=d.open("undefined"==typeof a.user?{templateUrl:"hue-bridge-modal-register-content",controller:HueBridgeRegisterModalInstanceCtrl,resolve:{socket:function(){return b},bridge:function(){return a},registrationComplete:function(){return f}}}:{templateUrl:"hue-bridge-modal-lights-content",controller:HueBridgeLightsModalInstanceCtrl,resolve:{socket:function(){return b},bridge:function(){return a}}}),g.result.then(function(){},function(){e.info("Modal dismissed at: "+new Date)})}}]);var HueBridgeRegisterModalInstanceCtrl=function(a,b,c,d,e){a.bridge=d,a.registerHueBridgeDisabled=!1,a.alerts=[],a.closeAlert=function(b){a.alerts.splice(b,1)},a.$on("socket:hue-bridge-registration-complete",function(b,c){console.log("Hue Bridge Registration Complete "+JSON.stringify(c)),c.err&&a.alerts.push({type:"danger",msg:"Error: "+c.err.message.capitalize()}),a.registerHueBridgeDisabled=!1,e(b,c)}),a.register=function(){a.alerts=[],a.registerHueBridgeDisabled=!0,c.emit("hue",{action:"register",bridge:d},function(){console.log("emit callback")})},a.cancel=function(){b.dismiss("cancel")}},HueBridgeLightsModalInstanceCtrl=function(a,b,c,d){a.bridge=d,a.alerts=[],c.emit("hue",{action:"getLights",bridge:d},function(){console.log("emit callback")}),a.$on("socket:hue-bridge-get-lights",function(b,c){c.err?a.alerts.push({type:"danger",msg:"Error: "+c.err.message.capitalize()}):a.lights=c.lights}),a.$on("socket:hue-bridge-lights",function(b,c){c.err?a.alerts.push({type:"danger",msg:"Error: "+c.err.message.capitalize()}):console.log("Hue Bridge Lights Response "+JSON.stringify(c))}),a.closeAlert=function(b){a.alerts.splice(b,1)},a.turnOn=function(b){a.alerts=[],c.emit("hue",{action:"on",bridge:d,light:b},function(){console.log("emit callback")})},a.turnOff=function(b){a.alerts=[],c.emit("hue",{action:"off",bridge:d,light:b},function(){console.log("emit callback")})},a.cancel=function(){b.dismiss("cancel")}};angular.module("interDromeApp").controller("BleepCtrl",["$scope","Bleep",function(a,b){a.data=b.get(),a.selectedBleep,a.editBleep=function(b){a.selectedBleep=b},a.itemClass=function(b){return b===a.selectedBleep?"list-group-item active":"list-group-item"}}]),angular.module("interDromeApp").controller("EventCtrl",["$scope",function(){}]),angular.module("interDromeApp").controller("NotificationCtrl",["$scope",function(){}]),angular.module("interDromeApp").factory("Auth",["$location","$rootScope","Session","User","$cookieStore",function(a,b,c,d,e){return b.currentUser=e.get("user")||null,e.remove("user"),{login:function(a,d){var e=d||angular.noop;return c.save({email:a.email,password:a.password},function(a){return b.currentUser=a,e()},function(a){return e(a)}).$promise},logout:function(a){var d=a||angular.noop;return c.delete(function(){return b.currentUser=null,d()},function(a){return d(a)}).$promise},createUser:function(a,c){var e=c||angular.noop;return d.save(a,function(a){return b.currentUser=a,e(a)},function(a){return e(a)}).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.update({oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},currentUser:function(){return d.get()},adminUser:function(){var a=d.get();return a},isLoggedIn:function(){var a=b.currentUser;return!!a}}}]),angular.module("interDromeApp").factory("Session",["$resource",function(a){return a("/api/session/")}]),angular.module("interDromeApp").factory("User",["$resource",function(a){return a("/api/users/:id",{id:"@id"},{update:{method:"PUT",params:{}},get:{method:"GET",params:{id:"me"}}})}]),angular.module("interDromeApp").factory("HueBridge",["$resource",function(a){return a("/api/hue/bridges",{},{update:{method:"PUT",params:{}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").factory("Bleep",["$resource",function(a){return a("/api/bleeps",{},{update:{method:"PUT",params:{}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").factory("Wemo",["$resource",function(a){return a("/api/wemo",{},{update:{method:"PUT",params:{}},get:{method:"GET",params:{}}})}]),angular.module("interDromeApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("interDromeApp").directive("a",function(){return{restrict:"E",link:function(a,b,c){(c.ngClick||""===c.href||"#"===c.href)&&b.on("click",function(b){b.preventDefault(),c.ngClick&&a.$eval(c.ngClick)})}}});